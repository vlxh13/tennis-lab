<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <title>Revue de Presse</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #1a1a2e;
            color: #eee;
            min-height: 100vh;
            padding: 20px;
            padding-top: env(safe-area-inset-top, 20px);
        }

        header {
            text-align: center;
            margin-bottom: 24px;
            padding-bottom: 16px;
            border-bottom: 1px solid #333;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .date {
            color: #888;
            font-size: 0.9rem;
        }

        .refresh-btn {
            background: #4a4a6a;
            border: none;
            color: #fff;
            padding: 8px 16px;
            border-radius: 8px;
            margin-top: 12px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .refresh-btn:active {
            background: #5a5a7a;
        }

        .category {
            margin-bottom: 24px;
        }

        .category-title {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .article {
            background: #252542;
            border-radius: 12px;
            padding: 14px;
            margin-bottom: 10px;
        }

        .article-header {
            display: flex;
            gap: 10px;
            align-items: flex-start;
        }

        .article-num {
            background: #4a4a6a;
            color: #fff;
            font-size: 0.75rem;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 6px;
            flex-shrink: 0;
        }

        .article-title {
            font-size: 0.95rem;
            font-weight: 500;
            line-height: 1.4;
        }

        .article-desc {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 8px;
            line-height: 1.5;
        }

        .article-source {
            font-size: 0.75rem;
            color: #666;
            margin-top: 8px;
        }

        .article-actions {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            padding-top: 10px;
            border-top: 1px solid #3a3a5a;
        }

        .action-btn {
            flex: 1;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-size: 0.85rem;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .action-btn:active {
            transform: scale(0.98);
        }

        .btn-source {
            background: #3a3a5a;
            color: #fff;
        }

        .btn-deep {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
            color: #1a1a2e;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #3a2020;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            color: #f88;
        }

        .category-emoji {
            font-size: 1.2rem;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: #00ff88;
            color: #1a1a2e;
            padding: 14px 24px;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.9rem;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
            text-align: center;
            max-width: 90%;
        }

        .toast.show {
            opacity: 1;
        }

        .toast-sub {
            font-weight: 400;
            font-size: 0.8rem;
            margin-top: 4px;
            opacity: 0.8;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-top: 12px;
        }

        .maj-btn {
            background: #3a3a5a;
            border: none;
            color: #888;
            padding: 8px 14px;
            border-radius: 8px;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .maj-btn:active {
            background: #4a4a6a;
        }

        .version-header {
            color: #444;
            font-size: 0.7rem;
            margin-top: 8px;
        }
    </style>
</head>
<body>
    <header>
        <h1>üì∞ Revue de Presse</h1>
        <div class="date" id="dateDisplay">Chargement...</div>
        <div class="header-actions">
            <button class="refresh-btn" onclick="loadNews()">üîÑ Actualiser</button>
            <button class="maj-btn" onclick="forceUpdate()">‚öôÔ∏è MAJ</button>
        </div>
        <div class="version-header">v3.0</div>
    </header>

    <main id="content">
        <div class="loading">Chargement des actualit√©s...</div>
    </main>

    <div class="toast" id="toast"></div>

    <script>
        const CATEGORIES = {
            'FRANCE': 'üá´üá∑',
            'INTERNATIONAL': 'üåç',
            '√âCONOMIE': 'üí∞',
            'SOCI√âT√â': 'üë•',
            'SPORT': '‚öΩ',
            'CULTURE': 'üé≠',
            'TECH': 'üíª'
        };

        const CATEGORY_ORDER = ['FRANCE', 'INTERNATIONAL', '√âCONOMIE', 'SOCI√âT√â', 'SPORT', 'CULTURE', 'TECH'];

        // Store articles globally for deep search
        let articlesData = {};

        function getToday() {
            const d = new Date();
            return d.toISOString().split('T')[0];
        }

        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            return d.toLocaleDateString('fr-FR', options);
        }

        function showToast(message, sub) {
            const toast = document.getElementById('toast');
            toast.innerHTML = message + (sub ? `<div class="toast-sub">${sub}</div>` : '');
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 3000);
        }

        async function loadNews() {
            const content = document.getElementById('content');
            const dateDisplay = document.getElementById('dateDisplay');

            content.innerHTML = '<div class="loading">Chargement des actualit√©s...</div>';

            const today = getToday();
            const jsonUrl = `actu_${today}.json`;

            try {
                const response = await fetch(jsonUrl + '?t=' + Date.now());
                if (!response.ok) {
                    throw new Error('Fichier non trouv√©');
                }

                const articles = await response.json();
                articlesData = articles;
                dateDisplay.textContent = formatDate(today);

                renderArticles(articles);
            } catch (e) {
                // Essayer la veille
                const yesterday = new Date();
                yesterday.setDate(yesterday.getDate() - 1);
                const yesterdayStr = yesterday.toISOString().split('T')[0];

                try {
                    const response = await fetch(`actu_${yesterdayStr}.json?t=` + Date.now());
                    if (response.ok) {
                        const articles = await response.json();
                        articlesData = articles;
                        dateDisplay.textContent = formatDate(yesterdayStr) + ' (hier)';
                        renderArticles(articles);
                        return;
                    }
                } catch (e2) {}

                content.innerHTML = `
                    <div class="error">
                        Pas d'actualit√©s disponibles pour aujourd'hui.<br><br>
                        Lance <code>python fetch_actu.py</code> pour g√©n√©rer.
                    </div>
                `;
            }
        }

        function renderArticles(articles) {
            const content = document.getElementById('content');

            // Grouper par cat√©gorie
            const byCategory = {};
            Object.entries(articles).forEach(([num, article]) => {
                const cat = article.category || 'AUTRE';
                if (!byCategory[cat]) byCategory[cat] = [];
                byCategory[cat].push({ num, ...article });
            });

            let html = '';

            CATEGORY_ORDER.forEach(cat => {
                if (!byCategory[cat] || byCategory[cat].length === 0) return;

                const emoji = CATEGORIES[cat] || 'üì∞';
                html += `
                    <div class="category">
                        <div class="category-title">
                            <span class="category-emoji">${emoji}</span>
                            ${cat}
                        </div>
                `;

                byCategory[cat].forEach(article => {
                    const encodedUrl = encodeURIComponent(article.url || '');
                    html += `
                        <div class="article">
                            <div class="article-header">
                                <span class="article-num">${article.num}</span>
                                <span class="article-title">${escapeHtml(article.title)}</span>
                            </div>
                            ${article.description ? `<div class="article-desc">${escapeHtml(article.description)}</div>` : ''}
                            <div class="article-source">${escapeHtml(article.source || '')}</div>
                            <div class="article-actions">
                                <button class="action-btn btn-source" onclick="openArticle('${encodedUrl}')">
                                    üì∞ Source
                                </button>
                                <button class="action-btn btn-deep" onclick="deepSearch('${article.num}')">
                                    üîç Creuser
                                </button>
                            </div>
                        </div>
                    `;
                });

                html += '</div>';
            });

            content.innerHTML = html || '<div class="error">Aucun article trouv√©</div>';
        }

        function escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function openArticle(encodedUrl) {
            const url = decodeURIComponent(encodedUrl);
            if (url && url !== 'undefined') {
                window.open(url, '_blank');
            }
        }

        function deepSearch(num) {
            const article = articlesData[num];
            if (!article) {
                showToast('Article non trouv√©');
                return;
            }

            // G√©n√©rer le prompt deep search (DEEP PRESS by L'Architecte)
            const prompt = `Tu es un journaliste d'investigation. Ta mission : produire un article de fond sur ce sujet.

## SUJET
Titre : ${article.title}
Contexte initial : ${article.description || 'Pas de contexte disponible'}

## PROTOCOLE DE RECHERCHE (OBLIGATOIRE)

### √âtape 1 ‚Äî Collecte massive
Lance WebSearch sur 4-5 angles diff√©rents :
- L'√©v√©nement factuel (qui, quoi, quand, o√π)
- Les causes / le contexte historique
- Les r√©actions officielles et politiques
- Les analyses d'experts ou √©ditorialistes
- Les cons√©quences attendues

### √âtape 2 ‚Äî Approfondissement
Utilise WebFetch sur les 5-6 meilleures sources trouv√©es. Privil√©gie :
- Agences de presse (AFP, Reuters, AP)
- Quotidiens de r√©f√©rence (Le Monde, NYT, Guardian)
- M√©dias sp√©cialis√©s selon le sujet

### √âtape 3 ‚Äî V√©rification crois√©e
Ne retiens une information QUE si elle appara√Æt dans au moins 2 sources distinctes.
En cas de contradiction entre sources, mentionne-le explicitement.

## FORMAT DE L'ARTICLE

Structure journalistique classique :

**CHAP√î** (2-3 phrases)
L'essentiel en ouverture. Accroche + fait central.

**CONTEXTE** (1 paragraphe)
Ce qu'il faut savoir pour comprendre. Historique si pertinent.

**D√âVELOPPEMENT** (3-5 paragraphes)
Les faits d√©taill√©s, les acteurs, les enjeux. Citations si disponibles.
Chaque affirmation doit pouvoir √™tre rattach√©e √† une source.

**R√âACTIONS** (1-2 paragraphes)
Ce qu'en disent les parties prenantes, les experts, l'opposition.

**PERSPECTIVES** (1 paragraphe)
Et maintenant ? Que surveiller ? Prochaines √©tapes.

## R√àGLES ABSOLUES

1. **Z√âRO HALLUCINATION** ‚Äî Si tu ne trouves pas l'info, √©cris "Information non confirm√©e dans les sources consult√©es"
2. **SOURCING SYST√âMATIQUE** ‚Äî Chaque section doit mentionner d'o√π vient l'info
3. **TONALIT√â** ‚Äî Factuel, pr√©cis, sobre. Pas de sensationnalisme, pas d'opinion personnelle.
4. **LONGUEUR** ‚Äî Minimum 800 mots. C'est un article de fond, pas une br√®ve.

## SOURCES (OBLIGATOIRE EN FIN D'ARTICLE)

Liste compl√®te en markdown :
- [Titre de l'article](URL) ‚Äî Source, date si dispo
(Minimum 5 sources, id√©al 6-8)

---

Commence par ta recherche. Prends ton temps. La qualit√© prime sur la vitesse.`;

            // Copier dans le presse-papier
            navigator.clipboard.writeText(prompt).then(() => {
                showToast('‚úÖ Prompt copi√© !', 'Ouvre Claude et colle');

                // Essayer d'ouvrir l'app Claude apr√®s un court d√©lai
                setTimeout(() => {
                    // Tenter diff√©rents URL schemes
                    window.location.href = 'claude://';
                }, 500);
            }).catch(err => {
                // Fallback pour iOS si clipboard √©choue
                showToast('üìã Appuie longuement pour copier', article.title.substring(0, 40) + '...');

                // Cr√©er un textarea temporaire pour s√©lection manuelle
                const ta = document.createElement('textarea');
                ta.value = prompt;
                ta.style.position = 'fixed';
                ta.style.top = '50%';
                ta.style.left = '10%';
                ta.style.width = '80%';
                ta.style.height = '200px';
                ta.style.zIndex = '9999';
                ta.style.background = '#252542';
                ta.style.color = '#fff';
                ta.style.border = '2px solid #00ff88';
                ta.style.borderRadius = '12px';
                ta.style.padding = '12px';
                ta.style.fontSize = '12px';
                document.body.appendChild(ta);
                ta.select();

                // Supprimer apr√®s 5 secondes
                setTimeout(() => ta.remove(), 5000);
            });
        }

        // Force update PWA
        function forceUpdate() {
            showToast('üîÑ Mise √† jour...', 'Rechargement en cours');

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.getRegistrations().then(registrations => {
                    registrations.forEach(reg => reg.unregister());
                });
            }

            if ('caches' in window) {
                caches.keys().then(names => {
                    names.forEach(name => caches.delete(name));
                });
            }

            setTimeout(() => {
                window.location.reload(true);
            }, 500);
        }

        // Charger au d√©marrage
        loadNews();

        // Register service worker
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(e => console.log('SW error:', e));
        }
    </script>
</body>
</html>
